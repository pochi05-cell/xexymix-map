<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì ì‹œë¯¹ìŠ¤ ì¬ê³  ê´€ë¦¬ - ìµœì¢…íŒ</title>
    <style>
        :root { 
            --yellow: #fdd835; /* ì§„í•œ ë…¸ë‘ */
            --yellow-light: #fff59d; 
            --gray-border: #9e9e9e;
            --accent: #4CAF50; 
            --highlight: #ff5252; 
            --dark-bg: rgba(0,0,0,0.7); 
        }
        body { font-family: -apple-system, sans-serif; background: #333; margin: 0; display: flex; flex-direction: column; align-items: center; overflow-x: hidden; }
        
        /* í—¤ë” */
        .global-header { width: 360px; background: white; display: flex; gap: 8px; padding: 10px; border-radius: 0 0 15px 15px; position: sticky; top: 0; z-index: 2000; box-sizing: border-box; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        #searchInput { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; outline: none; }
        .btn { width: 42px; height: 42px; border: none; border-radius: 8px; background: #f0f0f0; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition:0.2s; }
        .btn.active { background: var(--accent); color: white; }
        .btn.mode-active { background: var(--highlight); color: white; animation: pulse 1s infinite; }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        /* ì§€ë„ ì»¨í…Œì´ë„ˆ */
        .map-container { background: white; width: 360px; height: 780px; position: relative; border-radius: 15px; margin: 10px 0; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .area-label { background: #eee; padding: 12px; text-align: center; font-weight: bold; color: #555; border-bottom: 1px solid #ddd; }
        
        /* ì¹´ìš´í„° ì˜ì—­ (íšŒìƒ‰ í…Œë‘ë¦¬) */
        .counter-zone {
            position: absolute; top: 600px; left: 20px; right: 20px; height: 100px;
            border: 3px solid var(--gray-border); background-color: #f5f5f5; border-radius: 10px;
            display: flex; align-items: center; justify-content: center; z-index: 0;
        }
        .counter-text {
            position: absolute; top: -12px; background: #f5f5f5; padding: 0 10px;
            font-weight: bold; color: #555; font-size: 14px;
        }

        /* ë°•ìŠ¤ ë””ìì¸ (ì „ë¶€ ë…¸ë‘) */
        .box { 
            position: absolute !important; 
            border: 1px solid #b7950b; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 10px; font-weight: bold; cursor: pointer; 
            border-radius: 3px; box-sizing: border-box; 
            background-color: var(--yellow); 
            color: #333;
            box-shadow: 1px 1px 3px rgba(0,0,0,0.2);
            transition: transform 0.1s; 
            z-index: 5;
        }
        .box:active { transform: scale(0.95); }
        
        /* ì•„ì¼ëœë“œ (Y3, Y3-4 ê²¹ì¹¨) */
        .island { transform: rotate(-45deg); width: 68px; height: 68px; border-radius: 8px; }
        #Y3 { z-index: 20; } /* ìœ„ë¡œ ì˜¬ë¼ì˜´ */
        #Y3-4 { width: 90px !important; height: 90px !important; z-index: 10; font-size: 13px; box-shadow: 0 0 10px rgba(0,0,0,0.1); background-color: var(--yellow-light); }
        .island-sq { transform: rotate(-45deg); width: 45px !important; height: 45px !important; z-index: 50; }

        /* ìˆ˜ì • ëª¨ë“œ ì˜¤ë²„ë ˆì´ */
        .edit-overlay { position: fixed; inset: 0; background: var(--dark-bg); z-index: 1500; display: none; pointer-events: none; }
        body.edit-mode .edit-overlay { display: block; }
        body.edit-mode .box { z-index: 1600; border: 2px solid white; box-shadow: 0 0 15px rgba(255,255,255,0.8); }
        /* ìˆ˜ì • ëª¨ë“œ ì•„ì¼ëœë“œ íšŒì „ ìœ ì§€ */
        body.edit-mode .island, body.edit-mode .island-sq { transform: rotate(-45deg) !important; z-index: 1600 !important; }

        /* ë¦¬ìŠ¤íŠ¸ ì‚¬ì´ë“œë°” (ê¸°ëŠ¥ ì¶”ê°€) */
        .drawer { position: fixed; top: 0; left: -320px; width: 300px; height: 100%; background: white; z-index: 4000; transition: 0.3s; box-shadow: 2px 0 10px rgba(0,0,0,0.3); overflow-y: auto; display: flex; flex-direction: column; }
        .drawer.open { left: 0; }
        .drawer-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 3500; display: none; }
        .drawer-overlay.open { display: block; }
        
        /* ë¦¬ìŠ¤íŠ¸ ë‚´ í’ˆë²ˆ ì¶”ê°€ ì˜ì—­ */
        .add-zone { padding: 20px; background: #fafafa; border-bottom: 1px solid #ddd; }
        .add-zone h4 { margin: 0 0 10px 0; font-size: 14px; color: #333; }
        .input-group { display: flex; gap: 5px; }
        .input-group input { flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 5px; outline: none; }
        .input-group button { padding: 10px; background: #333; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        
        .drawer-list-container { flex: 1; overflow-y: auto; padding: 10px; }
        .drawer-item { padding: 12px 10px; border-bottom: 1px solid #f0f0f0; font-size: 14px; cursor: pointer; }
        .drawer-item b { color: #dda0dd; /* ì—°ë³´ë¼ìƒ‰ ê°•ì¡° */ margin-right: 5px; }

        /* íŒì—… ëª¨ë‹¬ */
        .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:5000; align-items:flex-end; justify-content:center; }
        .pop-content { background:white; width:100%; max-width:400px; border-radius:20px 20px 0 0; padding: 25px 20px; box-sizing: border-box; }
        .layer-row { display: flex; flex-direction: column; gap: 5px; margin-bottom: 12px; background: #f9f9f9; padding: 10px; border-radius: 8px; border: 1px solid #eee; }
        textarea { width: 100%; height: 50px; border: 1px solid #ddd; border-radius: 5px; resize: none; padding: 8px; font-size: 14px; box-sizing: border-box; outline: none; }

        /* ê·¸ë¦¬ë“œ */
        .grid-container { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 8px; margin-top: 10px; }
        .grid-item { background: #f9f9f9; padding: 8px; border-radius: 8px; border: 1px solid #eee; }

        .blink { animation: blink 0.6s infinite; background-color: var(--highlight) !important; color: white !important; z-index: 2000 !important; }
        @keyframes blink { 50% { opacity: 0.3; } }
        
        /* ë°°ì¹˜ ëª¨ë“œ ì•ˆë‚´ ë©”ì‹œì§€ */
        #assignMsg { position: fixed; top: 70px; left: 50%; transform: translateX(-50%); background: var(--highlight); color: white; padding: 10px 20px; border-radius: 20px; font-size: 14px; font-weight: bold; z-index: 3000; display: none; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

<div class="edit-overlay"></div>
<div class="drawer-overlay" onclick="closeDrawer()"></div>
<div id="assignMsg">ë°•ìŠ¤ë¥¼ ëˆŒëŸ¬ ë°°ì¹˜í•˜ì„¸ìš”!</div>

<div id="drawer" class="drawer">
    <div class="add-zone">
        <h4>âœ¨ ìƒˆ í’ˆë²ˆ ì¶”ê°€í•˜ê¸°</h4>
        <div class="input-group">
            <input type="text" id="newCode" placeholder="í’ˆë²ˆ ì…ë ¥ (ì˜ˆ: XP9108)">
            <button onclick="startAssignMode()">ì§€ë„ì—<br>ë°°ì¹˜</button>
        </div>
        <p style="font-size:11px; color:#666; margin-top:5px;">ì…ë ¥ í›„ ë²„íŠ¼ì„ ëˆ„ë¥´ê³ , ì§€ë„ì—ì„œ ë°•ìŠ¤ë¥¼ í´ë¦­í•˜ì„¸ìš”.</p>
    </div>
    <div class="drawer-list-container" id="drawerList"></div>
</div>

<div class="global-header">
    <button class="btn" onclick="openDrawer()">ğŸ“‹</button>
    <input type="text" id="searchInput" placeholder="í’ˆë²ˆ ê²€ìƒ‰..." onkeyup="search(this.value)">
    <button id="backupBtn" class="btn" style="display:none; background:#555; color:white;" onclick="openBackup()">ğŸ’¾</button>
    <button id="editBtn" class="btn" onclick="toggleEdit()">âœï¸</button>
</div>

<div class="main-wrapper">
    <div class="map-container" id="shopMap">
        <div class="area-label">&lt;ë§¤ì¥&gt;</div>
        
        <div class="counter-zone">
            <div class="counter-text">ì¹´ìš´í„°</div>
        </div>
    </div>
    <div class="map-container" id="stockMap" style="height: 400px;">
        <div class="area-label">&lt;ì°½ê³ &gt;</div>
    </div>
</div>

<div id="overlay" class="modal"><div class="pop-content">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <h3 id="popTitle" style="margin:0;"></h3>
        <button onclick="closePop()" style="border:none; background:none; font-size:20px;">âœ•</button>
    </div>
    <div id="popLayers"></div>
    <button onclick="save()" style="width:100%; padding:15px; background:var(--accent); color:white; border:none; border-radius:10px; margin-top:15px; font-weight:bold; font-size:16px;">ì €ì¥ ì™„ë£Œ</button>
</div></div>

<div id="backupModal" class="modal" style="align-items: center;"><div class="pop-content" style="background:#fff; border-radius:15px; width:90%;">
    <h3>ë°±ì—… ë° ë³µêµ¬</h3>
    <textarea id="backupArea" style="width:100%; height:100px; background:#f5f5f5; border:1px solid #ccc; font-family:monospace; margin-bottom:10px;"></textarea>
    <div style="display:flex; gap:10px;">
        <button onclick="importData()" style="flex:1; padding:12px; background:var(--accent); color:white; border:none; border-radius:8px;">ë³µêµ¬</button>
        <button onclick="document.getElementById('backupModal').style.display='none'" style="flex:1; padding:12px; background:#666; color:white; border:none; border-radius:8px;">ë‹«ê¸°</button>
    </div>
</div></div>

<script>
    // [ë°ì´í„°: ëª¨ë“  ë°•ìŠ¤ yellow, ì¢Œí‘œ ì¡°ì •]
    const shopBoxes = [
        // ì•„ì¼ëœë“œ (Y3, Y3-4 ê²¹ì¹¨ êµ¬í˜„)
        {id:'Y3', t:155, l:145, f:1, type:'island'},      // ì•½ê°„ ì˜¤ë¥¸ìª½ ì•„ë˜ë¡œ ì´ë™í•´ ê²¹ì¹¨
        {id:'Y3-4', t:175, l:158, f:4, type:'island'},    // ì¤‘ì‹¬
        {id:'Y4', t:238, l:218, f:1, type:'island'},      
        
        {id:'Br1', t:210, l:95, f:4, type:'island-sq'}, 
        {id:'Br2', t:255, l:140, f:4, type:'island-sq'},

        // ì£¼ë³€ B ì‹œë¦¬ì¦ˆ (ëª¨ë‘ ë…¸ë‘)
        {id:'B1', t:130, l:25, w:38, h:55, f:1}, {id:'B2', t:195, l:25, w:38, h:55, f:1},
        {id:'B3', t:260, l:25, w:38, h:55, f:1}, {id:'B4', t:325, l:25, w:38, h:55, f:1},
        {id:'B5', t:130, r:25, w:38, h:55, f:1}, {id:'B6', t:195, r:25, w:38, h:55, f:1},
        {id:'B7', t:260, r:25, w:38, h:55, f:1}, {id:'B8', t:325, r:25, w:38, h:55, f:1},
        
        // í•˜ë‹¨ë¶€
        {id:'B9', t:395, l:85, w:70, h:38, f:1}, {id:'B10', t:395, r:85, w:70, h:38, f:1},
        {id:'Y5', t:450, r:25, w:38, h:70, f:4}, {id:'Y6', t:450, l:220, w:38, h:70, f:4},
        {id:'Br3', t:585, l:65, w:32, h:50, f:2}, {id:'Br4', t:645, l:65, w:32, h:50, f:2},
        {id:'Y7', t:585, r:30, w:38, h:75, f:4}, {id:'Y8', t:650, l:145, w:80, h:45, f:2},
        {id:'Y9', t:650, l:235, w:80, h:45, f:2},

        // [ì¹´ìš´í„°] Y5, Y6 ì•„ë˜ìª½ (íšŒìƒ‰ ë°•ìŠ¤ ì•ˆ)
        {id:'Y1', t:620, l:50, w:80, h:60, f:2}, 
        {id:'Y2', t:620, r:50, w:80, h:60, f:2}
    ];

    const stockBoxes = [
        {id:'S1', t:70, l:10}, {id:'S2', t:70, l:78}, {id:'S3', t:70, l:146}, {id:'S4', t:70, l:214}, {id:'S5', t:70, l:282},
        {id:'S6', t:140, l:15, w:55, h:90}, {id:'S7', t:140, r:15, w:55, h:90}, {id:'S8', t:240, l:75, w:55, h:90}, {id:'S9', t:305, l:135, w:85, h:45}
    ];

    let isEdit = false, isAssigning = false, pendingCode = "";
    let currId = null;
    let storage = JSON.parse(localStorage.getItem('xexy_final_v4')) || {};

    function init() {
        createBoxes(shopBoxes, 'shopMap');
        createBoxes(stockBoxes, 'stockMap');
        updateDrawer();
    }

    function createBoxes(data, targetId) {
        const target = document.getElementById(targetId);
        data.forEach(b => {
            const div = document.createElement('div');
            div.id = b.id;
            // ëª¨ë“  ë°•ìŠ¤ yellow ê¸°ë°˜, ì•„ì¼ëœë“œëŠ” ì¶”ê°€ í´ë˜ìŠ¤
            div.className = `box ${b.type || ''}`; 
            div.innerText = b.id;
            div.style.cssText = `top:${b.t}px; ${b.l?'left:'+b.l+'px': (b.r?'right:'+b.r+'px':'')}; width:${b.w||60}px; height:${b.h||40}px;`;
            div.onclick = () => handleBoxClick(b.id, b.f || 1);
            target.appendChild(div);
        });
    }

    // [ë°•ìŠ¤ í´ë¦­ ë¡œì§] ë°°ì¹˜ ëª¨ë“œ vs ì¼ë°˜ ëª¨ë“œ ë¶„ê¸°
    function handleBoxClick(id, f) {
        if(isAssigning) {
            // ë°°ì¹˜ ëª¨ë“œ: í•´ë‹¹ ë°•ìŠ¤ì˜ ì²« ë²ˆì§¸ ë¹ˆì¹¸ì— í’ˆë²ˆ ë„£ê¸°
            assignToBox(id, f);
        } else {
            // ì¼ë°˜ ëª¨ë“œ: íŒì—… ì—´ê¸° (ìˆ˜ì •/ì´ë™ ê°€ëŠ¥)
            openPop(id, f);
        }
    }

    // [ë°°ì¹˜ ëª¨ë“œ ì‹œì‘]
    function startAssignMode() {
        const code = document.getElementById('newCode').value.trim();
        if(!code) { alert("í’ˆë²ˆì„ ì…ë ¥í•´ì£¼ì„¸ìš”!"); return; }
        
        pendingCode = code;
        isAssigning = true;
        closeDrawer();
        
        document.getElementById('assignMsg').style.display = 'block';
        document.getElementById('assignMsg').innerText = `'${code}' ë„£ì„ ë°•ìŠ¤ë¥¼ ëˆ„ë¥´ì„¸ìš”!`;
        document.body.style.cursor = "crosshair"; // ì»¤ì„œ ë³€ê²½
    }

    // [ë°°ì¹˜ ì‹¤í–‰ ë¡œì§]
    function assignToBox(id, maxF) {
        if(!storage[id]) storage[id] = new Array(maxF).fill("");
        
        // ë¹ˆ ì¹¸ ì°¾ê¸° (ë§¨ ì•ë¶€í„°)
        let inserted = false;
        for(let i=0; i<maxF; i++) {
            if(!storage[id][i]) {
                storage[id][i] = pendingCode;
                inserted = true;
                break;
            }
        }
        // ê½‰ ì°¼ìœ¼ë©´ ë§ˆì§€ë§‰ ì¹¸ì— ë®ì–´ì“°ê±°ë‚˜, ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼ (ì—¬ê¸°ì„  ë§ˆì§€ë§‰ ì¹¸ì— ì¶”ê°€/ë®ì–´ì“°ê¸°ë¡œ ì²˜ë¦¬)
        if(!inserted) {
            if(confirm(`[${id}] ë°•ìŠ¤ê°€ ê½‰ ì°¼ìŠµë‹ˆë‹¤. ë§ˆì§€ë§‰ ì¹¸ì— ë®ì–´ì“¸ê¹Œìš”?`)) {
                storage[id][maxF-1] = pendingCode;
            } else {
                return; // ì·¨ì†Œ
            }
        }

        localStorage.setItem('xexy_final_v4', JSON.stringify(storage));
        
        // ì´ˆê¸°í™”
        isAssigning = false;
        pendingCode = "";
        document.getElementById('newCode').value = "";
        document.getElementById('assignMsg').style.display = 'none';
        document.body.style.cursor = "default";
        
        alert(`[${id}]ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        updateDrawer();
    }

    function openPop(id, f) {
        currId = id; document.getElementById('popTitle').innerText = id;
        const saved = storage[id] || [];
        let html = '';

        if(id === 'Y3-4') {
            html = `<div class="grid-container">`;
            const labels = ['ìƒë‹¨ì¢Œ', 'ìƒë‹¨ìš°', 'í•˜ë‹¨ì¢Œ', 'í•˜ë‹¨ìš°'];
            for(let i=0; i<4; i++) {
                html += `<div class="grid-item"><b>${labels[i]}</b><textarea id="ipt_${i}">${saved[i]||''}</textarea></div>`;
            }
            html += `</div>`;
        } else {
            for(let i=0; i<f; i++) {
                html += `<div class="layer-row"><b>${i+1}F</b><textarea id="ipt_${i}">${saved[i]||''}</textarea></div>`;
            }
        }
        document.getElementById('popLayers').innerHTML = html;
        document.getElementById('overlay').style.display = 'flex';
    }

    function save() {
        const ipts = document.querySelectorAll('#popLayers textarea');
        storage[currId] = Array.from(ipts).map(i => i.value);
        localStorage.setItem('xexy_final_v4', JSON.stringify(storage));
        updateDrawer();
        closePop();
    }

    function toggleEdit() {
        isEdit = !isEdit;
        document.body.classList.toggle('edit-mode', isEdit);
        document.getElementById('editBtn').classList.toggle('active', isEdit);
        document.getElementById('backupBtn').style.display = isEdit ? 'flex' : 'none';
    }

    function openDrawer() {
        document.getElementById('drawer').classList.add('open');
        document.querySelector('.drawer-overlay').classList.add('open');
        updateDrawer();
    }
    function closeDrawer() {
        document.getElementById('drawer').classList.remove('open');
        document.querySelector('.drawer-overlay').classList.remove('open');
    }

    function updateDrawer() {
        let html = '';
        const sortedKeys = Object.keys(storage).sort();
        
        sortedKeys.forEach(key => {
            const items = storage[key].filter(v => v && v.trim() !== '');
            if(items.length > 0) {
                html += `<div class="drawer-item" onclick="moveToBox('${key}')"><b>[${key}]</b> ${items.join(', ')}</div>`;
            }
        });
        document.getElementById('drawerList').innerHTML = html || '<p style="text-align:center; color:#999; margin-top:20px;">ì €ì¥ëœ í’ˆë²ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>';
    }

    function moveToBox(id) {
        closeDrawer();
        const target = document.getElementById(id);
        if(target) {
            target.classList.add('blink');
            target.scrollIntoView({behavior:'smooth', block:'center'});
        }
    }
    
    function closePop() { document.getElementById('overlay').style.display = 'none'; }
    
    function search(q) {
        document.querySelectorAll('.box').forEach(b => b.classList.remove('blink'));
        if(!q.trim()) return;
        for(let id in storage) {
            if(storage[id].some(v => v.toLowerCase().includes(q.toLowerCase()))) {
                const target = document.getElementById(id);
                if(target) target.classList.add('blink');
            }
        }
    }

    function openBackup() {
        document.getElementById('backupArea').value = JSON.stringify(storage);
        document.getElementById('backupModal').style.display = 'flex';
    }
    function importData() {
        try {
            const val = document.getElementById('backupArea').value;
            if(!val) return;
            storage = JSON.parse(val);
            localStorage.setItem('xexy_final_v4', JSON.stringify(storage));
            alert("ë³µêµ¬ ì™„ë£Œ!");
            location.reload();
        } catch(e) { alert("ë°ì´í„° ì˜¤ë¥˜"); }
    }

    init();
</script>
</body>
</html>
