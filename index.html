<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì ì‹œë¯¹ìŠ¤ ì¬ê³ ì§€ë„ - ìµœì¢… ìˆ˜ì •íŒ</title>
    <style>
        :root { --yellow: #ffdb6d; --brown: #d9d2ae; --blue: #cfd8dc; --accent: #4CAF50; --highlight: #ff4d4d; --gray: #e0e0e0; }
        body { font-family: -apple-system, sans-serif; background: #333; margin: 0; display: flex; flex-direction: column; align-items: center; overflow-x: hidden; }
        
        /* í—¤ë” */
        .global-header { width: 360px; background: white; display: flex; gap: 8px; padding: 10px; border-radius: 0 0 15px 15px; position: sticky; top: 0; z-index: 2000; box-sizing: border-box; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        #searchInput { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; outline: none; }
        .btn { width: 42px; height: 42px; border: none; border-radius: 8px; background: #f0f0f0; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; position: relative; z-index: 2100; }
        
        /* ì§€ë„ ì»¨í…Œì´ë„ˆ */
        .map-container { background: white; width: 360px; height: 740px; position: relative; border-radius: 15px; margin: 10px 0; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .area-label { background: #eee; padding: 12px; text-align: center; font-weight: bold; }
        .box { position: absolute; border: 1.5px solid #333; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; cursor: pointer; border-radius: 2px; box-sizing: border-box; transition: 0.2s; z-index: 10; }
        
        .yellow { background-color: var(--yellow) !important; }
        .brown { background-color: var(--brown) !important; }
        .blue { background-color: var(--blue) !important; }
        .counter-box { background-color: var(--gray) !important; font-size: 12px; }

        /* íŠ¹ì • ë°•ìŠ¤ í¬ê¸° ì¡°ì ˆ */
        #Y3-4 { width: 110px !important; height: 110px !important; z-index: 100; font-size: 14px; }
        .island-sq { transform: rotate(-45deg); width: 45px !important; height: 45px !important; z-index: 50; }

        /* ì•Œë¦¼ ë©”ì‹œì§€ */
        #assignMsg { position: fixed; top: 80px; left: 50%; transform: translateX(-50%); background: var(--highlight); color: white; padding: 12px 25px; border-radius: 30px; font-size: 14px; font-weight: bold; z-index: 5000; display: none; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .blink { animation: blink 0.6s infinite; background-color: var(--highlight) !important; color: white !important; }
        @keyframes blink { 50% { opacity: 0.4; } }

        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:9000; align-items:center; justify-content:center; }
        .modal.at-bottom { align-items: flex-end; }
        .pop-content { background:white; width:90%; max-width:400px; border-radius:20px; padding: 20px; box-sizing: border-box; max-height: 85vh; overflow-y: auto; }
        .modal.at-bottom .pop-content { width: 100%; border-radius: 20px 20px 0 0; }
        
        .layer-row { display: flex; flex-direction: column; gap: 4px; margin-bottom: 12px; border-bottom: 1px solid #eee; padding-bottom: 8px; }
        .layer-header { display: flex; justify-content: space-between; align-items: center; }
        textarea { width: 100%; height: 45px; border: 1px solid #ddd; border-radius: 5px; resize: none; padding: 8px; font-size: 14px; box-sizing: border-box; margin-top: 5px; }
        
        .drawer { position: fixed; top: 0; left: -320px; width: 300px; height: 100%; background: white; z-index: 4000; transition: 0.3s; box-shadow: 2px 0 10px rgba(0,0,0,0.3); display: flex; flex-direction: column; }
        .drawer.open { left: 0; }
        .drawer-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 3500; display: none; }
        .drawer-overlay.open { display: block; }
    </style>
</head>
<body>

<div class="drawer-overlay" onclick="toggleDrawer()"></div>
<div id="assignMsg">1. ë°°ì¹˜í•  ë°•ìŠ¤ë¥¼ ì„ íƒí•˜ì„¸ìš”</div>

<div id="drawer" class="drawer">
    <div class="drawer-header" style="padding:15px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
        <h3>ğŸ“¦ í’ˆë²ˆ ë¦¬ìŠ¤íŠ¸</h3>
        <button onclick="toggleDrawer()" style="border:none; background:none; font-size:22px;">âœ•</button>
    </div>
    <div style="padding:15px; background:#fffde7;">
        <div style="display:flex; gap:5px;">
            <input type="text" id="newCode" placeholder="ì‹ ê·œ í’ˆë²ˆ" style="flex:1; padding:10px; border:1px solid #ccc; border-radius:4px;">
            <button onclick="startAssign()" style="background:var(--accent); color:white; border:none; padding:0 15px; border-radius:4px; font-weight:bold;">ë°°ì¹˜</button>
        </div>
    </div>
    <div id="drawerList" style="flex:1; overflow-y:auto; padding:10px;"></div>
</div>

<div class="global-header">
    <button class="btn" onclick="toggleDrawer()">ğŸ“‹</button>
    <input type="text" id="searchInput" placeholder="í’ˆë²ˆ ê²€ìƒ‰..." onkeyup="search(this.value)">
    <button class="btn" onclick="openBackup()" style="background:#e3f2fd;">ğŸ’¾</button>
</div>

<div class="main-wrapper">
    <div class="map-container" id="shopMap"><div class="area-label">&lt;ë§¤ì¥&gt;</div></div>
    <div class="map-container" id="stockMap" style="height: 400px;"><div class="area-label">&lt;ì°½ê³ &gt;</div></div>
</div>

<div id="overlay" class="modal at-bottom"><div class="pop-content">
    <h3 id="popTitle" style="margin-top:0;"></h3>
    <div id="popLayers"></div>
    <button id="saveBtn" onclick="saveData()" style="width:100%; padding:15px; background:var(--accent); color:white; border:none; border-radius:10px; margin-top:15px; font-weight:bold;">ì €ì¥í•˜ê¸°</button>
    <button onclick="closePop()" style="width:100%; padding:10px; background:#eee; border:none; border-radius:10px; margin-top:8px;">ë‹«ê¸°</button>
</div></div>

<div id="backupModal" class="modal"><div class="pop-content">
    <h3 style="margin-top:0;">ğŸ’¾ ë°ì´í„° ë°±ì—…/ë³µêµ¬</h3>
    <textarea id="backupArea" style="height:200px; font-family:monospace;"></textarea>
    <div style="display:flex; gap:10px; margin-top:15px;">
        <button onclick="importData()" style="flex:1; padding:15px; background:var(--highlight); color:white; border:none; border-radius:10px; font-weight:bold;">ë³µêµ¬</button>
        <button onclick="closeBackup()" style="flex:1; padding:15px; background:#eee; border:none; border-radius:10px;">ë‹«ê¸°</button>
    </div>
</div></div>

<script>
    const shopBoxes = [
        {id:'Y1', c:'yellow', t:70, l:60, w:90, h:35, f:2}, {id:'Y2', c:'yellow', t:70, r:30, w:90, h:35, f:2},
        {id:'Y3', c:'blue island', t:135, l:125, f:1}, {id:'Y3-4', c:'blue island', t:175, l:158, f:4},
        {id:'Y4', c:'blue island', t:238, l:218, f:1}, {id:'Br1', c:'brown island-sq', t:210, l:95, f:4},
        {id:'Br2', c:'brown island-sq', t:255, l:140, f:4},
        {id:'B1', c:'blue', t:130, l:25, w:38, h:55, f:1}, {id:'B2', c:'blue', t:195, l:25, w:38, h:55, f:1},
        {id:'B3', c:'blue', t:260, l:25, w:38, h:55, f:1}, {id:'B4', c:'blue', t:325, l:25, w:38, h:55, f:1},
        {id:'B5', c:'blue', t:130, r:25, w:38, h:55, f:1}, {id:'B6', c:'blue', t:195, r:25, w:38, h:55, f:1},
        {id:'B7', c:'blue', t:260, r:25, w:38, h:55, f:1}, {id:'B8', c:'blue', t:325, r:25, w:38, h:55, f:1},
        {id:'B9', c:'blue', t:395, l:85, w:70, h:38, f:1}, {id:'B10', c:'blue', t:395, r:85, w:70, h:38, f:1},
        {id:'Y5', c:'yellow', t:450, r:25, w:38, h:70, f:4}, {id:'Y6', c:'yellow', t:450, l:220, w:38, h:70, f:4},
        // ì¹´ìš´í„° ì¶”ê°€ (Y5, Y6 ë°‘ / Y7 ìœ„)
        {id:'Counter', c:'counter-box', t:540, l:45, w:270, h:25, f:1},
        {id:'Br3', c:'brown', t:585, l:65, w:32, h:50, f:2}, {id:'Br4', c:'brown', t:645, l:65, w:32, h:50, f:2},
        {id:'Y7', c:'yellow', t:585, r:30, w:38, h:75, f:4}, {id:'Y8', c:'yellow', t:650, l:145, w:80, h:45, f:2},
        {id:'Y9', c:'yellow', t:650, l:235, w:80, h:45, f:2}
    ];

    const stockBoxes = [
        {id:'S1', t:70, l:10, c:'yellow', f:8}, {id:'S2', t:70, l:78, c:'yellow', f:8}, {id:'S3', t:70, l:146, c:'yellow', f:8}, 
        {id:'S4', t:70, l:214, c:'yellow', f:8}, {id:'S5', t:70, l:282, c:'yellow', f:8},
        {id:'S6', t:140, l:15, w:55, h:90, c:'yellow', f:8}, {id:'S7', t:140, r:15, w:55, h:90, c:'yellow', f:8}, 
        {id:'S8', t:240, l:75, w:55, h:90, c:'yellow', f:8}, {id:'S9', t:305, l:135, w:85, h:45, c:'yellow', f:8}
    ];

    let storage = JSON.parse(localStorage.getItem('xexy_v_final_data')) || {};
    let isAssignMode = false, assignCode = "", currId = null;

    function init() {
        renderBoxes(shopBoxes, 'shopMap');
        renderBoxes(stockBoxes, 'stockMap');
        updateList();
    }

    function renderBoxes(data, containerId) {
        const container = document.getElementById(containerId);
        data.forEach(b => {
            const div = document.createElement('div');
            div.id = b.id; div.className = `box ${b.c}`; div.innerText = b.id;
            div.style.cssText = `top:${b.t}px; ${b.l?'left:'+b.l+'px': (b.r?'right:'+b.r+'px':'')}; width:${b.w||60}px; height:${b.h||40}px;`;
            div.onclick = (e) => { e.stopPropagation(); handleBoxClick(b.id, b.f); };
            container.appendChild(div);
        });
    }

    function handleBoxClick(id, maxF) {
        currId = id;
        if (isAssignMode) document.getElementById('assignMsg').innerText = "2. ë°°ì¹˜í•  ì¸µì„ ì„ íƒí•˜ì„¸ìš”";
        openPop(id, maxF);
    }

    function openPop(id, f) {
        document.getElementById('popTitle').innerText = id;
        const saved = storage[id] || new Array(f).fill("");
        let html = '';
        
        // ì°½ê³ (S) ë°•ìŠ¤ì¸ ê²½ìš° ì¸µìˆ˜ë¥¼ ì—­ìˆœ(8ì¸µì´ ìœ„, 1ì¸µì´ ì•„ë˜)ìœ¼ë¡œ ë Œë”ë§
        const isStock = id.startsWith('S');
        const indices = [];
        for(let i=0; i<f; i++) indices.push(i);
        if(isStock) indices.reverse();

        indices.forEach(i => {
            const label = id === 'Y3-4' ? `ì˜ì—­ ${i+1}` : `${i+1}ì¸µ`;
            html += `
                <div class="layer-row">
                    <div class="layer-header">
                        <b>${label}</b>
                        <button onclick="confirmAssign(${i})" style="display:${isAssignMode?'block':'none'}; background:var(--highlight); color:white; border:none; padding:5px 10px; border-radius:4px;">ì—¬ê¸°ì— ë°°ì¹˜</button>
                    </div>
                    <textarea id="ipt_${i}">${saved[i]||''}</textarea>
                </div>`;
        });
        document.getElementById('popLayers').innerHTML = html;
        document.getElementById('saveBtn').style.display = isAssignMode ? 'none' : 'block';
        document.getElementById('overlay').style.display = 'flex';
    }

    function confirmAssign(floorIdx) {
        if(!storage[currId]) {
            const box = [...shopBoxes, ...stockBoxes].find(b => b.id === currId);
            storage[currId] = new Array(box.f).fill("");
        }
        let old = storage[currId][floorIdx].trim();
        storage[currId][floorIdx] = old ? `${old}, ${assignCode}` : assignCode;
        saveToStorage(); isAssignMode = false;
        document.getElementById('assignMsg').style.display = 'none';
        closePop(); updateList(); search(assignCode);
    }

    function saveData() {
        const ipts = document.querySelectorAll('#popLayers textarea');
        const newData = new Array(ipts.length).fill("");
        ipts.forEach(ipt => {
            const idx = ipt.id.split('_')[1];
            newData[idx] = ipt.value;
        });
        storage[currId] = newData;
        saveToStorage(); closePop(); updateList();
    }

    function startAssign() {
        const val = document.getElementById('newCode').value.trim();
        if(!val) return alert("í’ˆë²ˆ ì…ë ¥ í•„ìˆ˜");
        assignCode = val; isAssignMode = true; toggleDrawer();
        document.getElementById('assignMsg').style.display = 'block';
    }

    function openBackup() {
        document.getElementById('backupArea').value = JSON.stringify(storage);
        document.getElementById('backupModal').style.display = 'flex';
    }
    function closeBackup() { document.getElementById('backupModal').style.display = 'none'; }
    function importData() {
        try {
            storage = JSON.parse(document.getElementById('backupArea').value);
            saveToStorage(); location.reload();
        } catch(e) { alert("ì˜ëª»ëœ ë°ì´í„°"); }
    }

    function toggleDrawer() {
        document.getElementById('drawer').classList.toggle('open');
        document.querySelector('.drawer-overlay').classList.toggle('open');
    }
    function updateList() {
        let html = '';
        Object.keys(storage).sort().forEach(id => {
            const items = storage[id].filter(v => v && v.trim() !== "");
            if(items.length > 0) html += `<div style="padding:10px; border-bottom:1px solid #eee; font-size:13px;"><b>[${id}]</b> ${items.join(', ')}</div>`;
        });
        document.getElementById('drawerList').innerHTML = html;
    }
    function search(q) {
        document.querySelectorAll('.box').forEach(b => b.classList.remove('blink'));
        if(!q.trim()) return;
        for(let id in storage) {
            if(storage[id].some(v => v.toLowerCase().includes(q.toLowerCase()))) {
                const target = document.getElementById(id);
                if(target) target.classList.add('blink');
            }
        }
    }
    function saveToStorage() { localStorage.setItem('xexy_v_final_data', JSON.stringify(storage)); }
    function closePop() { document.getElementById('overlay').style.display = 'none'; }
    init();
</script>
</body>
</html>
